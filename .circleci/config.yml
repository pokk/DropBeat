version: 2.1

jobs:
  build:
    working_directory: ~/workspace
    environment:
      JVM_OPTS: -Xms512m -Xmx4096m
      _JAVA_OPTIONS: -Xms512m -Xmx4096m
      GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx4096m -XX:+HeapDumpOnOutOfMemoryError" -Dorg.gradle.caching=true -Dorg.gradle.configureondemand=true -Dkotlin.compiler.execution.strategy=in-process -Dkotlin.incremental=false
      ANDROID_API_LEVEL: 30
      EMULATOR_API_LEVEL: 22
      ANDROID_ABI: armeabi-v7a
      ANDROID_TAG: google_apis
      ANDROID_TARGET: android-$ANDROID_API_LEVEL
      ADB_INSTALL_TIMEOUT: 20 # minutes (2 minutes by default)
    docker:
      - image: circleci/android@sha256:061e2535826cc3fe4c4a440e716bf06c36c80401ee635c339c6803b3e427ebb3
    steps:
      - checkout
      - run:
          name: Decode Api URL
          command: echo ${MUSIC_URI} | base64 --decode > ${HOME}/workspace/local.properties
      - restore_cache:
          key: jars-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}
      - run:
          name: Decode Google Services Key
          command: echo ${GOOGLE_SERVICE} | base64 --decode > ${HOME}/workspace/app/google-services.json
      - run:
          name: Decode Enviorment Config Keys
          command: |
            echo ${LOCAL_PROPERTIES} | base64 --decode > ${HOME}/workspace/local.properties
            echo ${RANKING_RESOURCE} | base64 --decode > ${HOME}/workspace/feature/ranking/src/main/res/values/ranks.xml
            echo ${FACEBOOK_KEYS} | base64 --decode > ${HOME}/workspace/app/src/main/res/values/facebook_key.xml
            #            echo ${TWITTER_KEYS} | base64 --decode > ${HOME}/workspace/app/src/main/res/values/twitter_key.xml
            echo ${LASTFM_KEYS} | base64 --decode > ${HOME}/workspace/feature/explore/src/main/res/values/keys.xml
            echo ${SSL_CERTFICATION} | base64 --decode > ${HOME}/workspace/core/src/main/res/raw/mycertfile.crt
      - run:
          name: Check Dependencies
          command: ./gradlew
      - save_cache:
          paths:
            - ~/.gradlew
          key: jars-{{ checksum "build.gradle" }}-{{ checksum "app/build.gradle" }}
      - run:
          name: Assemble Debug APK
          command: ./gradlew assembleDebug
      #      - run:
      #          name: Generate JaCoCo report
      #          command: ./gradlew jacocoAndroidTestReport
      #      - run:
      #          name: Upload coverage report to CodeCov
      #          command: bash <(curl -s https://codecov.io/bash)
      - store_artifacts:
          path: app/build/outputs/apk
          destination: apk
      - store_test_results:
          path: app/build/test-results
